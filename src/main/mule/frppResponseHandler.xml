<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
	xmlns:vm="http://www.mulesoft.org/schema/mule/vm"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/current/mule-vm.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd">
	
	
	<sub-flow name="ProcessAllBatchReponses" doc:id="ffd995db-76b5-4b31-87eb-8cf71d62d99d" >
		<logger level="INFO" doc:name="Log Start Processing Response" doc:id="9673e976-0e75-4186-878c-f83e06ccb7a5" message="Started processing responses" />
		<set-variable value="#[p('thread.maxThreads') - vars.threadPoolSize]" doc:name="Set Response Counter" doc:id="71c7196c-f14c-4556-a2c1-2782795d22ac" variableName="responseCounter" />
		<flow-ref doc:name="ProcessThreadResponse" doc:id="06c9183f-ad9c-468b-82dc-83294a19d393" name="ProcessThreadResponse" />
		<logger level="INFO" doc:name="Log Response Processing  Complete" doc:id="1cb0e821-da49-475b-ba9b-4e1faf8a6402" message="Completed Processing Responses" />
		<set-variable value="#[p('thread.maxThreads')]" doc:name="Reset Thread Pool" doc:id="a6eb60b2-3f87-473d-972f-0b69f65e3848" variableName="threadPoolSize" />
	</sub-flow>
	
	
	
	<sub-flow name="ProcessThreadResponse" doc:id="e13e22b8-274e-4144-b897-ef152c35763a" >
		<choice doc:name="Choice" doc:id="d76ee862-5f5c-43b2-974c-a4a3045f8a47" >
			<when expression="#[vars.responseCounter &gt; 0]">
				<vm:consume queueName="#[vars.queueName]" doc:name="Consume" target="vmResponse" doc:id="74b0968a-c624-49e0-ad7f-4fcce89d1158" config-ref="VM_Batch_Config" timeout="300"/>
				<salesforce:query doc:name="Get Count of SF processed assets" doc:id="ce17289f-1cc9-4bec-91ee-6e8fb66938e9" config-ref="SalesforceGeoFL3_Global" target="countSFProcessedAssets">
					<salesforce:salesforce-query >select ID, Number_of_processed_assets__c from FRPP_File__c where ID = ':field'</salesforce:salesforce-query>
					<salesforce:parameters ><![CDATA[#[output application/java
---
{
	"field" : vars.file.Id
}]]]></salesforce:parameters>
				</salesforce:query>
				<ee:transform doc:name="update Counts" doc:id="2455f9f2-9547-4b4f-8dd9-5d956a2bd694">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="updateStatusReq"><![CDATA[%dw 2.0
output application/json
---
[{
	Id: vars.file.Id,
	Number_of_processed_assets__c: (vars.countSFProcessedAssets[0].Number_of_processed_assets__c) + (vars.vmResponse.countRecordSuccessAdded) + (vars.vmResponse.countRecordErrorAdded)
}
]]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
				<flow-ref doc:name="SetStatuses" doc:id="458c8c6a-7b29-4ca8-acf7-80773b22a9ac" name="SetStatuses" />
				<logger level="INFO" doc:name="Logger" doc:id="b7b7a51b-56f4-485e-837c-632e0c648755" message="Response from Thread : #[vars.vmResponse.threadId]  Success Record Added: #[vars.vmResponse.countRecordSuccessAdded] Failure Record Added: #[vars.vmResponse.countRecordErrorAdded]" />
				<set-variable value="#[vars.responseCounter -1]" doc:name="ReduceResponseCounter" doc:id="c48cec76-dceb-45ad-bb2a-bbb1c205751b" variableName="responseCounter"/>
				<flow-ref doc:name="ContinueProcessingResponse" doc:id="794f2370-72f9-4ac8-b615-25f9704abed9" name="ProcessThreadResponse"/>
			</when>
		</choice>
	</sub-flow>
	
	
</mule>
